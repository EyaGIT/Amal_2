\documentclass[tikz,border=10pt]{standalone}
\usepackage{tikz}
\usetikzlibrary{shapes,arrows.meta,positioning,fit,backgrounds}

% Styles
\tikzset{
  service/.style={rectangle, rounded corners, draw=black, very thick, minimum width=4cm, minimum height=1.2cm, align=center, fill=green!15},
  db/.style={cylinder, shape border rotate=90, draw=black, very thick, minimum height=1.4cm, minimum width=1cm, aspect=0.5, align=center, fill=orange!20},
  broker/.style={rectangle, draw=black, thick, minimum width=3.5cm, minimum height=1cm, align=center, fill=blue!15},
  arrow/.style={-{Latex[length=3mm,width=2mm]}, thick},
  component/.style={rectangle, draw=black!60, very thin, rounded corners, inner sep=8pt, fill=gray!10}
}

\begin{document}
\begin{tikzpicture}[node distance=16mm and 28mm, every node/.style={font=\footnotesize}]

% Top: External clients
\node (user) [component, fill=cyan!20] {Clients / Frontend / API Consumers};

% API Gateway & Auth
\node (gateway) [service, fill=cyan!25, below=of user, yshift=-10mm] {API Gateway \\ (Auth, Rate-limit)};
\node (auth) [service, fill=cyan!15, right=of gateway, xshift=40mm] {Auth Service \\ (OAuth2 / Keycloak)};

% Ingestion and Broker
\node (ingest) [service, fill=green!20, below=of gateway, yshift=-12mm] {Ingestion Service \\ (validation, enrichment)};
\node (broker) [broker, below=of ingest, yshift=-10mm, fill=blue!25] {Message Broker \\ (Kafka / RabbitMQ)};

% Workers cluster (supprimé le rectangle de regroupement)
\node (preproc) [service, below=of broker, xshift=-40mm, yshift=-16mm, fill=green!20] {Pre-Processing \\ Workers};
\node (ml) [service, below=of broker, yshift=-16mm, fill=green!20] {ML Inference \\ Workers (GPU optional)};
\node (enrich) [service, below=of broker, xshift=40mm, yshift=-16mm, fill=green!20] {Enrichment \\ Workers};

% Orchestrator
\node (orchestrator) [service, left=of preproc, xshift=-40mm, fill=green!30] {Orchestrator / Workflow \\ (Temporal / Argo)};

% Storages
\node (postgres) [db, right=of ml, xshift=50mm, fill=orange!25] {DB\\(Postgres)};
\node (nosql) [db, below=of postgres, yshift=4mm, fill=orange!25] {NoSQL\\(Mongo)};
\node (s3) [component, below right=of enrich, xshift=20mm, fill=yellow!20] {Object Storage \\ (S3 / MinIO)};

% Notification & Aggregation
\node (notify) [service, right=of s3, xshift=34mm, fill=green!25] {Notification Service \\ (email, webhook, sms)};
\node (bff) [service, above=of notify, yshift=18mm, fill=cyan!15] {BFF / API Aggregator};

% Observability
\node (observ) [component, left=of orchestrator, xshift=-38mm, fill=purple!10] {Observability};
\node (prom) [service, below=of observ, yshift=6mm, fill=purple!15] {Prometheus};
\node (graf) [service, below=of prom, yshift=6mm, fill=purple!15] {Grafana};
\node (jaeger) [service, below=of graf, yshift=6mm, fill=purple!15] {Jaeger / Tracing};

% CI/CD & Infra
\node (k8s) [component, below left=of preproc, xshift=-24mm, fill=gray!20] {Kubernetes Cluster \\ (Helm, HPA)};
\node (ci) [component, below=of k8s, yshift=10mm, fill=gray!25] {CI/CD (GitHub Actions / GitLab CI)};

% Draw arrows
\draw[arrow] (user) -- (gateway);
\draw[arrow] (gateway) -- (ingest);
\draw[arrow] (gateway) -- (auth);
\draw[arrow] (ingest) -- (broker);
\draw[arrow] (broker) -- (preproc);
\draw[arrow] (broker) -- (ml);
\draw[arrow] (broker) -- (enrich);
\draw[arrow] (preproc) -- (orchestrator);
\draw[arrow] (ml) -- (postgres);
\draw[arrow] (enrich) -- (nosql);
\draw[arrow] (preproc) -- (s3);
\draw[arrow] (ml) -- (s3);
\draw[arrow] (s3) -- (notify);
\draw[arrow] (notify) -- (bff);
\draw[arrow] (bff) -- (gateway);

% Observability links
\draw[arrow] (preproc.west) to [out=200,in=0] (prom.east);
\draw[arrow] (ml.west) to [out=210,in=0] (prom.east);
\draw[arrow] (enrich.west) to [out=220,in=0] (prom.east);
\draw[arrow] (prom) -- (graf);
\draw[arrow] (prom) -- (jaeger);

% Infra links
\draw[arrow] (k8s) -- (preproc.south);
\draw[arrow] (k8s) -- (ml.south);
\draw[arrow] (ci) -- (k8s);

% Labels for parallelism
\node[align=center,font=\small] at ($(broker.south)+(0,-1.2)$) {Topics / Partitions \\ (processing parallèle)};

% Grouping only observability
\node[draw=black!40, rounded corners, fit=(prom) (graf) (jaeger) (observ), inner sep=12pt] {};

\end{tikzpicture}
\end{document}
